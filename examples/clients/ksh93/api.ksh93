#!/usr/local/bin/ksh93
#
# OpenADMS Server API test routines in KornShell 93
#
# This script requires `ksh93`, `curl`, and `jq`.
#
# Date:   2020-03-26
# Author: Philipp Engel
#
host="api.example.com"
user=username
password=password

pid="<project id>"
nid="<sensor node id>"
oid="<observation id>"
sensor="<sensor name>"
target="<target name>"
log_id="<log id>"
start="2020-01-01T00:00:00"
end="2022-01-01T00:00:00"

base_api="https://${host}/api/v1/"

print -- "----------------------------------------------------------------------------------------------------"
print -- "-- Testing OpenADMS Server API"
print -- "--"
print -- "-- KornShell ${KSH_VERSION}"
print -- "--"
print -- "-- API: ${base_api}"
print -- "-- PID: ${pid}"
print -- "-- NID: ${nid}"
print -- "-- OID: ${oid}"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_version_json()"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url=${base_api}
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_log_json(${log_id})"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/logs/${log_id}/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_log_csv(${log_id})"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/logs/${log_id}/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_log_json(0)"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/logs/0/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_log_csv(0)"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/logs/0/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_observation_json('${oid}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/observations/${oid}/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_observation_json('0')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/observations/0/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_observation_csv('${oid}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/observations/${oid}/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_observation_csv('0')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/observations/0/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_project_ids_json()"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_project_ids_csv()"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_sensor_node_ids_json('${pid}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_sensor_node_ids_csv('${pid}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_sensor_node_ids_json('0')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_sensor_node_ids_csv('0')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_heartbeart_json('${pid}', '${nid}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/${nid}/heartbeat/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_heartbeart_csv('${pid}', '${nid}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/${nid}/heartbeat/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_heartbeart_json('0', '0')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/0/heartbeat/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_heartbeart_csv('0', '0')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/0/heartbeat/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_logs_json('${pid}', '${nid}', '${start}', '${end}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/${nid}/logs/?start=${start}&end=${end}"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_logs_csv('${pid}', '${nid}', '${start}', '${end}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/${nid}/logs/?start=${start}&end=${end}"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_logs_json('0', '0', '${start}', '${end}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/0/logs/?start=${start}&end=${end}"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_logs_csv('0', '0', '${start}', '${end}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/0/logs/?start=${start}&end=${end}"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_sensors_json('${pid}', '${nid}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/${nid}/sensors/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_sensors_csv('${pid}', '${nid}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/${nid}/sensors/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_sensors_json('0', '0')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/0/sensors/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_sensors_csv('0', '0')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/0/sensors/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_targets_json('${pid}', '${nid}', '${sensor}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/${nid}/sensors/${sensor}/targets/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_targets_csv('${pid}', '${nid}', '${sensor}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/${nid}/sensors/${sensor}/targets/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_targets_json('0', '0', 'dummy')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/0/sensors/dummy/targets/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_targets_csv('0', '0', 'dummy')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/0/sensors/dummy/targets/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_observation_ids_json('${pid}', '${nid}', '${sensor}', '${target}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/${nid}/sensors/${sensor}/targets/${target}/ids/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_observation_ids_csv('${pid}', '${nid}', '${sensor}', '${target}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/${nid}/sensors/${sensor}/targets/${target}/ids/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_observation_ids_json('0', '0', 'dummy', 'dummy')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/0/sensors/dummy/targets/dummy/ids/"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_observation_ids_csv('0', '0', 'dummy', 'dummy')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/0/sensors/dummy/targets/dummy/ids/"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_observations_json('${pid}', '${nid}', '${sensor}', '${target}', '${start}', '${end}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/${nid}/sensors/${sensor}/targets/${target}/observations/?start=${start}&end=${end}"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_observations_csv('${pid}', '${nid}', '${sensor}', '${target}', '${start}', '${end}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/${pid}/nodes/${nid}/sensors/${sensor}/targets/${target}/observations/?start=${start}&end=${end}"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_observations_json('0', '0', 'dummy', 'dummy', '${start}', '${end}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/0/sensors/dummy/targets/dummy/observations/?start=${start}&end=${end}"
curl --silent -X GET -u ${user}:${password} -H "Accept: application/json" -G "${url}" | jq
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"

print -- "----------------------------------------------------------------------------------------------------"
print -- "--"
print -- "-- get_observations_csv('0', '0', 'dummy', 'dummy', '${start}', '${end}')"
print -- "--"
print -- "----------------------------------------------------------------------------------------------------"
url="${base_api}/projects/0/nodes/0/sensors/dummy/targets/dummy/observations/?start=${start}&end=${end}"
curl --silent -X GET -u ${user}:${password} -H "Accept: text/csv" -G "${url}"
print "\n"
print -- "----------------------------------------------------------------------------------------------------"
print "\n"
